<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<link href="/css/topbar.css" rel="stylesheet" type="text/css">
<link href="/css/user/sidebar.css" rel="stylesheet" type="text/css">
<link href="/css/user/myPage.css" rel="stylesheet" type="text/css">
<title>My Account</title>
<style>
.section {
	width: 100%;
	margin-bottom: 3rem;
}

.form-group {
	margin-bottom: 1rem;
}

.form-label {
	display: block;
	color: #6f757d;
	margin-bottom: 0.5rem;
	font-size: 0.875rem;
}

.form-control {
	width: 100%;
	padding: 0.75rem;
	background-color: #252535;
	border: none;
	border-radius: 0.375rem;
	color: white;
	font-size: 0.875rem;
}

.form-control:focus {
	outline: none;
	box-shadow: 0 0 0 2px #5e37e9;
}

textarea.form-control {
	min-height: 100px;
	resize: none;
}

.radio-group {
	display: flex;
	gap: 0.5rem;
}

.radio-group span {
	font-size: 0.9rem;
}

.radio-input {
	accent-color: #5e37e9;
}

.btn {
	background-color: #5e37e9;
	color: white;
	border: none;
	border-radius: 0.375rem;
	padding: 0.75rem;
	font-size: 0.875rem;
	cursor: pointer;
	width: 100%;
	margin-top: 1.5rem;
	display: block;
}

.btn:hover {
	background-color: #8137e9;
}

.button {
	background-color: #5e37e9;
	color: white;
	border: none;
	border-radius: 0.375rem;
	padding: 0.75rem;
	font-size: 0.875rem;
	cursor: pointer;
	margin-left: 0.5rem;
}

.button:hover {
	background-color: #8137e9;
}

.verify-button {
	width: 100px;
}

.verification-section {
	display: none;
}

.verification-section.active {
	display: block;
}

.email-container {
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.email-container>input[type="email"] {
	width: calc(100% - 110px);
}

.verification-container {
	display: flex;
	align-items: center;
	gap: 0.5rem;
}

.verification-container>input[type="text"] {
	width: calc(100% - 110px);
}

#confirmPwText {
	font-size: 13px;
}

#ChangeConfirmPwText {
	font-size: 13px;
}
</style>
</head>
<body>
	<div th:replace="~{views/common/topbar :: topbar}"></div>
	<div class="main-content">
		<div th:replace="~{views/myPage/my_sidebar}"></div>
		<!-- Personal Information -->
		<div class="content_wrap flex_custom_wrap">
			<div class="content-header">
				<h1>My Account</h1>
			</div>
			<section class="section">
				<form action="updateInfo" method="post">
					<div class="form-group">
						<label class="form-label" for="id">아이디</label> <input type="text" id="id" class="form-control" th:value="${session.loginUser.userId}" readonly>
					</div>

					<div class="form-group">
						<label class="form-label" for="name">이름</label> <input type="text" name="userName" id="name" class="form-control" th:value="${session.loginUser.userName}">
					</div>

					<div class="form-group">
						<label class="form-label" for="nickname">닉네임</label> <input type="text" name="userNickname" id="nickname" class="form-control" th:value="${session.loginUser.userNickname}">
					</div>

					<div class="form-group">
						<label class="form-label" for="phone">전화번호</label> <input type="tel" name="userPhone" id="tel" class="form-control" th:value="${session.loginUser.userPhone}">
					</div>

					<div class="form-group">
						<label class="form-label" for="email">이메일</label>
						<div class="email-container">
							<input type="email" placeholder="Email" class="form-control" name="userEmail" id="email" th:value="${session.loginUser.userEmail}">
							<button type="button" class="button verify-button" onclick="showVerification()" id="emailBtn">인증하기</button>
						</div>
					</div>

					<div class="verification-section" id="verificationSection">
						<div class="form-group">
							<div class="verification-container">
								<input type="text" placeholder="인증번호 입력" class="form-control" name="confirmVerifi" id="confirmVerifi">
								<button type="button" class="button verify-button" id="confirmEmailBtn">확인</button>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label class="form-label" for="birthdate">생년월일</label> <input type="date" name="userBirth" id="birthdate" class="form-control" th:value="${session.loginUser.userBirth}">
					</div>

					<div class="form-group">
						<label class="form-label">성별</label>
						<div class="radio-group">
							<input type="radio" value="M" class="radio-input" name="userGender" id="male" th:checked="${session.loginUser.userGender == 'M'}"> <span>남자</span> <input type="radio" name="userGender" value="F" class="radio-input" id="female" th:checked="${session.loginUser.userGender == 'F'}"> <span>여자</span>
						</div>
					</div>

					<div class="form-group">
						<label class="form-label" for="description">한마디</label>
						<textarea name="userComment" id="description" class="form-control">[[${session.loginUser.userComment}]]</textarea>
					</div>

					<div class="form-group">
						<label class="form-label" for="password">비밀번호 *</label> <input type="password" id="password" class="form-control" placeholder="비밀번호를 입력하세요.">
					</div>
					<div id="confirmPwText"></div>
					<button type="button" class="btn" id="update">Update</button>
				</form>
			</section>

			<!-- Change Password -->
			<div class="content-header">
				<h1>Change password</h1>
			</div>
			<section class="section">
				<form action="changePw" method="post">
					<div class="form-group">
						<label class="form-label" for="current-password">현재 비밀번호</label> <input type="password" name="currentPwd" id="currentPwd" class="form-control" placeholder="현재 비밀번호를 입력하세요.">
					</div>
					<div id="ChangeConfirmPwText"></div>
					<div class="form-group">
						<label class="form-label" for="new-password">새 비밀번호</label> <input type="password" name="newPwd" id="newPwd" class="form-control" placeholder="새로운 비밀번호를 입력하세요.">
					</div>

					<div class="form-group">
						<label class="form-label" for="confirm-password">새 비밀번호 확인</label> <input type="password" name="newPwdConfirm" id="newPwdConfirm" class="form-control" placeholder="새로운 비밀번호를 확인 다시 입력하세요.">
					</div>
					<div id="ChangeConfirmPwTextCheck"></div>
					
					<button type="button" class="btn" id="changePw">Change Password</button>
				</form>
			</section>
		</div>
	</div>
	<script>
      const showVerification=()=>{
         const email = document.getElementById('email').value.trim();
         const verification  = document.getElementById('verificationSection');
         const emailBtn = document.getElementById('emailBtn');
         console.log(document.getElementById('email').value.trim());
         if(email ==''){
            alert('이메일을 입력해주세요.');
            verification.style.display='none';
         }else{
            $.ajax({
               url:'/users/emailCheck',
               data:{email:email},
               success:data=>{
                  alert('이메일이 발송되었습니다.');
                  verification.style.display='block';
                  confirmEmail = data;
                  emailBtn.disabled = true;
                  },
               error:data=>console.log(data)
            });
         }
      }
      
      confirmEmailBtn.addEventListener('click',()=> {
         const confirmEmailBtn = document.getElementById('confirmEmailBtn');
         const confirmVerifi = document.getElementById('confirmVerifi').value.trim();
         const verfication = document.getElementById('verificationSection');
         if(confirmVerifi == ''){
            alert('인증번호를 입력해주세요');
         }else if(confirmVerifi == confirmEmail){
            alert('이메일 인증이 완료되었습니다.');
            emailCheck = true;
            verfication.style.display = 'none';
         }else{
            alert('인증번호가 틀렸습니다.');
            emailCheck = false;
         }
      });
      
      document.getElementById('update').addEventListener('click', () => {
    	    const password = document.getElementById('password').value;
    	    $.ajax({
    	        url: '/users/checkPw',
    	        data: {password:password},
    	        success: data => {
    	            if (data == 1) {
    	                confirmPwText.innerText = '비밀번호가 일치합니다.';
    	                confirmPwText.style.color = 'green';
    	                document.querySelector('form[action="updateInfo"]').submit();
    	            } else {
    	                confirmPwText.innerText = '비밀번호가 일치하지 않습니다.';
    	                confirmPwText.style.color = 'red';
    	            }
    	        }
    	    });
    	});
      
      document.getElementById('changePw').addEventListener('click', () => {
  	    const currentPwd = document.getElementById('currentPwd').value;
  	  	const newPwd = document.getElementById('newPwd').value;
  		const newPwdConfirm = document.getElementById('newPwdConfirm').value;
	  	if(newPwd == newPwdConfirm){
	  	    $.ajax({
	  	        url: '/users/changeCheckPw',
	  	        data: {currentPwd:currentPwd},
	  	        success: data => {
	  	            if (data == 1) {
	  	            	ChangeconfirmPwText.innerText = '비밀번호가 일치합니다.';
	  	            	ChangeconfirmPwText.style.color = 'green';
	  	                document.querySelector('form[action="changePw"]').submit();
	  	            } else {
	  	            	ChangeconfirmPwText.innerText = '비밀번호가 일치하지 않습니다.';
	  	            	ChangeconfirmPwText.style.color = 'red';
	  	            }
	  	        }
	  	    });
  		} else{
  			// 여기에 newPwd랑 newPwdConfirm둘이 다릅니다 띄우기 "ChangeConfirmPwTextCheck"
  		}
  	});
   </script>
</body>
</html>